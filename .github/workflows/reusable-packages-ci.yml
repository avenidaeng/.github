# Reusable CI Workflow for TypeScript Packages
#
# Usage in other repos:
#
# jobs:
#   ci:
#     uses: avenidaeng/.github/.github/workflows/reusable-packages-ci.yml@main
#     with:
#       node-version: '22'
#     secrets: inherit

name: Packages CI

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "22"
      pnpm-version:
        description: "pnpm version to use"
        required: false
        type: string
        default: "9"
      working-directory:
        description: "Working directory for the project"
        required: false
        type: string
        default: "."
      skip-build:
        description: "Skip the build step"
        required: false
        type: boolean
        default: false
      skip-test:
        description: "Skip the test step"
        required: false
        type: boolean
        default: false

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ inputs.pnpm-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "pnpm"
          cache-dependency-path: "${{ inputs.working-directory }}/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run type check
        run: pnpm typecheck

      - name: Build packages
        if: ${{ !inputs.skip-build }}
        run: pnpm build

      - name: Run tests
        if: ${{ !inputs.skip-test }}
        run: pnpm test
